unit uPessoa;

interface

uses uDataModule, System.SysUtils, System.Classes, Datasnap.DBClient;

type
  TPessoa = class
  public
    wCodigo   : Integer;
    wNome     : String;
    wEndereco : String;
    function fRetornarRelatorio() : TStringList;
    function fDeletarPessoa(prCodigo : Integer) : Boolean;
  end;

type
  TPessoaFisica = class(TPessoa)
  public
    wCPF      : String;
    procedure pInserirPessoaFisica(prPessoa : TPessoaFisica);
  end;

type
  TPessoaJuridica = class(TPessoa)
  public
    wIsento   : Boolean;
    wCNPJ     : String;
    procedure pInserirPessoaJuridica(prPessoa : TPessoaJuridica);
    function fRetornarPessoa(prCodigo : Integer) : TPessoaJuridica;
  end;

implementation

{ TPessoaJuridica }

function TPessoaJuridica.fRetornarPessoa(prCodigo: Integer): TPessoaJuridica;
var
  wPessoa : TPessoaJuridica;
begin
  wPessoa := TPessoaJuridica.Create;
  dmModulo.cdsDados.IndexFieldNames := 'bdCODIGO';
  if (dmModulo.cdsDados.FindKey([prCodigo])) then
     begin
       wPessoa.wCNPJ := dmModulo.cdsDados.FieldByName('bdCPF').AsString;
       wPessoa.wNome := dmModulo.cdsDados.FieldByName('bdNOME').AsString;
       wPessoa.wEndereco := dmModulo.cdsDados.FieldByName('bdENDERECO').AsString;
       wPessoa.wIsento := dmModulo.cdsDados.FieldByName('bdISENTO').AsBoolean;
     end;
  Result := wPessoa;
end;

procedure TPessoaJuridica.pInserirPessoaJuridica(prPessoa: TPessoaJuridica);
begin
  // Verifica se é uma inserção ou edição
  dmModulo.cdsDados.IndexFieldNames := 'bdCODIGO';
  if (dmModulo.cdsDados.FindKey([IntToStr(prPessoa.wCodigo)])) then
     dmModulo.cdsDados.Edit
  else
     dmModulo.cdsDados.Insert;

  // Coloca os dados no CDS
  dmModulo.cdsDados.FieldByName('bdCODIGO').AsInteger := prPessoa.wCodigo;
  dmModulo.cdsDados.FieldByName('bdTIPO').AsInteger := 1;
  dmModulo.cdsDados.FieldByName('bdCPF').AsString := prPessoa.wCNPJ;
  dmModulo.cdsDados.FieldByName('bdNOME').AsString := prPessoa.wNome;
  dmModulo.cdsDados.FieldByName('bdENDERECO').AsString := prPessoa.wEndereco;
  dmModulo.cdsDados.FieldByName('bdISENTO').AsBoolean := prPessoa.wIsento;

  // Salva os dados no CDS
  dmModulo.cdsDados.Post;
end;

{ TPessoaFisica }

procedure TPessoaFisica.pInserirPessoaFisica(prPessoa: TPessoaFisica);
begin
  // Verifica se é uma inserção ou edição
  dmModulo.cdsDados.IndexFieldNames := 'bdCODIGO';
  if (dmModulo.cdsDados.FindKey([IntToStr(prPessoa.wCodigo)])) then
     dmModulo.cdsDados.Edit
  else
     dmModulo.cdsDados.Insert;

  // Coloca os dados no CDS
  dmModulo.cdsDados.FieldByName('bdCODIGO').AsInteger := prPessoa.wCodigo;
  dmModulo.cdsDados.FieldByName('bdTIPO').AsInteger := 0;
  dmModulo.cdsDados.FieldByName('bdCPF').AsString := prPessoa.wCPF;
  dmModulo.cdsDados.FieldByName('bdNOME').AsString := prPessoa.wNome;
  dmModulo.cdsDados.FieldByName('bdENDERECO').AsString := prPessoa.wEndereco;
  dmModulo.cdsDados.FieldByName('bdISENTO').AsBoolean := False;

  // Salva os dados no CDS
  dmModulo.cdsDados.Post;
end;

{ TPessoa }

function TPessoa.fDeletarPessoa(prCodigo: Integer): Boolean;
begin
  try
    dmModulo.IndexFieldNames := 'bdCODIGO';
    if (dmModulo.cdsDados.FindKey([prCodigo])) then
       dmModulo.cdsDados.Delete;
       Result := True;
  except
    Result := False;
  end;
end;

function TPessoa.fRetornarRelatorio: TStringList;
var
  wSaida, wTipo, wIsento : String;
  wLista : TStringList;
begin
  wSaida := '';
  wLista := TStringList.Create;

  // Adiciona todos os dados do CDS em um arquivo e salva
  dmModulo.cdsDados.IndexFieldNames := 'bdCODIGO';
  dmModulo.cdsDados.First;

  while not(dmModulo.cdsDados.Eof) do
    begin
      if (dmModulo.cdsDados.FieldByName('bdTIPO').AsInteger = 0) then
         wTipo := 'Pessoa Física'
      else
         wTipo := 'Pessoa jurídica';

      if (dmModulo.cdsDados.FieldByName('bdISENTO').AsBoolean) then
         wIsento := 'Sim'
      else
         wIsento := 'Não';

      wSaida := wSaida + #13 +
      'Código: ' + IntToStr(dmModulo.cdsDados.FieldByName('bdCODIGO').AsInteger) + ' | ' +
      'Nome: ' + dmModulo.cdsDados.FieldByName('bdNOME').AsString + ' | ' +
      'CPF/CNPJ: ' + dmModulo.cdsDados.FieldByName('bdCPF').AsString + ' | ' +
      'Tipo: ' + wTipo + ' | ' +
      'Isento: ' + wIsento + ' | ' +
      'Endereço: ' + dmModulo.cdsDados.FieldByName('bdENDERECO').AsString;

      // Avança para a próxima linha
      dmModulo.cdsDados.Next;
    end;

  // Adiciona os dados na lista e retorna
  wLista.Add(wSaida);
  Result := wLista;
end;

end.
