/* CRIAÇÃO DA TABELA */
CREATE TABLE TMP_VEF_EMP_LANAGRUP_TEMP (
    BDSESSAO   INTEGER,
    BDCODEMP   INTEGER,
    BDREFLAN   INTEGER,
    BDCODPROD  INTEGER,
    BDVLRICMS  DM_NUMERIC_15_2
);

/* NÚMERO 1 */
INSERT INTO TMP_VEF_EMP_LANAGRUP_TEMP (BDSESSAO, BDCODEMP, BDREFLAN, BDCODPROD, BDVLRICMS)
SELECT 1, PRINCIPAL.BDCODEMP, PRINCIPAL.BDREFLAN, PRINCIPAL.BDCODPROD, PRINCIPAL.BDVLRICMS
FROM (

        SELECT ENT.*, PROD.BDCODPROD, PROD.BDVLRICMS
        FROM    (
                    SELECT ENT.BDCODEMP, ENT.BDREFLAN, ENT.BDCHAVE
                    FROM VEF_EMP_TMOVENT ENT
                    WHERE ENT.BDCODEMP = 67 AND ENT.BDREFLAN = 202101
                ) ENT
        JOIN VEF_EMP_TMOVENTITENS ITENS ON (ITENS.BDCODEMP = ENT.BDCODEMP AND ITENS.BDCHAVE = ENT.BDCHAVE)
        JOIN VEF_EMP_TMOVPROENT PROD ON (PROD.BDCODEMP = ITENS.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)

        UNION ALL

        SELECT SAI.*, PROD.BDCODPROD, PROD.BDVLRICMS
        FROM    (
                    SELECT SAI.BDCODEMP, SAI.BDREFLAN, SAI.BDCHAVE
                    FROM VEF_EMP_TMOVSAI SAI
                    WHERE SAI.BDCODEMP = 67 AND SAI.BDREFLAN = 202101
                ) SAI
        JOIN VEF_EMP_TMOVSAIITENS ITENS ON (ITENS.BDCODEMP = SAI.BDCODEMP AND ITENS.BDCHAVE = SAI.BDCHAVE)
        JOIN VEF_EMP_TMOVPROSAI PROD ON (PROD.BDCODEMP = SAI.BDCODEMP AND PROD.BDCHAVE = ITENS.BDCHAVE AND PROD.BDORDEM = ITENS.BDORDEM)
     ) PRINCIPAL;

/* NÚMERO 2 */
INSERT INTO VEF_EMP_TAJUICMSE111 (BDCODEMP, BDORDEME111220, BDREFERENCIA, BDVLRAJU)
SELECT INSERCAO.BDCODEMP, GETORDEMSEQUENCIAL(INSERCAO.BDCODEMP), INSERCAO.BDREFLAN, SUM(INSERCAO.BDVLRICMS)
FROM    (
            SELECT LANA.*
            FROM TMP_VEF_EMP_LANAGRUP_TEMP LANA
        ) INSERCAO
GROUP BY INSERCAO.BDCODEMP, INSERCAO.BDREFLAN, INSERCAO.BDCODPROD;





